services:
  ollama:
    image: ollama/ollama:latest
    container_name: "${COMPOSE_PROJECT_NAME:-chopsticks}-ollama"
    ports:
      - "11434:11434"
    volumes:
      - ollama:/root/.ollama
    restart: unless-stopped

  voice-llm:
    build:
      context: ./services/voice-llm
    container_name: "${COMPOSE_PROJECT_NAME:-chopsticks}-voice-llm"
    environment:
      # Backend priority order (comma-separated: anthropic,openai,ollama)
      - VOICE_LLM_BACKENDS=${VOICE_LLM_BACKENDS:-anthropic,openai,ollama}
      - VOICE_LLM_TIMEOUT_MS=${VOICE_LLM_TIMEOUT_MS:-15000}
      # Anthropic / Claude
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-3-haiku-20240307}
      - ANTHROPIC_MAX_TOKENS=${ANTHROPIC_MAX_TOKENS:-512}
      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      # Ollama (local fallback)
      - OLLAMA_URL=http://ollama:11434
      - OLLAMA_MODEL=${VOICE_OLLAMA_MODEL:-llama3.1:8b}
      - OLLAMA_OPTIONS=${VOICE_OLLAMA_OPTIONS:-}
    ports:
      - "9001:9001"
    depends_on:
      - ollama
    restart: unless-stopped

  voice-stt:
    build:
      context: ./services/voice-stt
    container_name: "${COMPOSE_PROJECT_NAME:-chopsticks}-voice-stt"
    environment:
      # Model: tiny (fastest), small (default), medium (better), large-v3 (best)
      - WHISPER_MODEL=${VOICE_WHISPER_MODEL:-small}
      - WHISPER_DEVICE=${VOICE_WHISPER_DEVICE:-cpu}
      - WHISPER_COMPUTE_TYPE=${VOICE_WHISPER_COMPUTE_TYPE:-int8}
      - WHISPER_CPU_THREADS=${VOICE_WHISPER_CPU_THREADS:-4}
      # Optional: set language hint to skip auto-detect (e.g. "en")
      - WHISPER_LANGUAGE=${VOICE_WHISPER_LANGUAGE:-}
      # VAD filter: removes silence and reduces hallucinations
      - WHISPER_VAD_FILTER=${VOICE_WHISPER_VAD_FILTER:-true}
    ports:
      - "9000:9000"
    restart: unless-stopped

  voice-tts:
    build:
      context: ./services/voice-tts
    container_name: "${COMPOSE_PROJECT_NAME:-chopsticks}-voice-tts"
    environment:
      - PIPER_BIN=/piper/piper
      - PIPER_MODEL=/piper/model.onnx
      - PIPER_CONFIG=/piper/model.onnx.json
      - PIPER_VOICES_DIR=/piper/voices
      - TTS_TARGET_RATE=48000
      - TTS_TARGET_CHANNELS=2
    volumes:
      - ./models/piper:/piper:ro
    ports:
      - "9002:9002"
    restart: unless-stopped

volumes:
  ollama:
